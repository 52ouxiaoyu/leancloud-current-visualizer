<!DOCTYPE html>
<html>
<head>
  <title>设备电流采样图</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- 日期适配器 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
</head>
<body>
  <h2>电流折线图</h2>
  <canvas id="chart" width="800" height="400"></canvas>
  <script>
    // 你的 LeanCloud 配置信息
    const appId = 'bOJAr1GSAwLB55qdhahyz0tp-gzGzoHsz';
    const appKey = 'gc9TLLQQwb6pYMFF8kpFJlLh';
    const className = 'CurrentData'; // 你的 Class 名称
    const deviceId = '8C4F00B1B338'; // 你的设备ID
    const limit = 500; // 取最近500条数据

    async function fetchData() {
      let url = `https://bojar1gs.lc-cn-n1-shared.com/1.1/classes/${className}?limit=${limit}&order=-timestamp`;
      if (deviceId) {
        const where = encodeURIComponent(JSON.stringify({ deviceId }));
        url += `&where=${where}`;
      }

      const res = await fetch(url, {
        headers: {
          'X-LC-Id': appId,
          'X-LC-Key': appKey,
          'Content-Type': 'application/json'
        }
      });
      const data = await res.json();
      if (!data.results) {
        console.error('数据格式错误', data);
        return [];
      }
      return data.results.map(entry => ({
        time: new Date(entry.timestamp.iso),
        current: parseFloat(entry.currents.split('_').slice(-1)[0])
      })).reverse();
    }

    async function renderChart() {
      const data = await fetchData();
      const ctx = document.getElementById('chart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.time),
          datasets: [{
            label: '电流 (A)',
            data: data.map(d => d.current),
            borderColor: 'blue',
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          parsing: false,
          scales: {
            x: {
              type: 'time',
              time: {
                tooltipFormat: 'yyyy-MM-dd HH:mm:ss',
                unit: 'minute',
                displayFormats: {
                  minute: 'HH:mm'
                }
              },
              title: {
                display: true,
                text: '时间 (中国时区)'
              }
            },
            y: {
              title: {
                display: true,
                text: '电流 (A)'
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `电流: ${ctx.parsed.y.toFixed(3)} A`
              }
            }
          }
        }
      });
    }

    renderChart();
  </script>
</body>
</html>