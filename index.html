<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>电流数据图表</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    #deviceSelect {
      margin-bottom: 1rem;
    }
    canvas {
      max-width: 100%;
    }
  </style>
</head>
<body>
  <h1>电流历史折线图</h1>
  <label for="deviceSelect">选择设备：</label>
  <select id="deviceSelect"></select>
  <canvas id="myChart" width="800" height="400"></canvas>

  <script>
    // LeanCloud 初始化
    AV.init({
      appId: "bOJAr1GSAwLB55qdhahyz0tp-gzGzoHsz",
      appKey: "gc9TLLQQwb6pYMFF8kpFJlLh",
      serverURL: "https://bojar1gs.lc-cn-n1-shared.com"
    });

    const CurrentData = AV.Object.extend("CurrentData");
    const chartCtx = document.getElementById("myChart").getContext("2d");
    let myChart;

    const deviceSelect = document.getElementById("deviceSelect");

    async function fetchDeviceIds() {
      const query = new AV.Query("CurrentData");
      query.limit(1000);
      query.select("deviceId");
      query.descending("createdAt");
      const results = await query.find();
      const ids = [...new Set(results.map(r => r.get("deviceId")))];
      ids.forEach(id => {
        const opt = document.createElement("option");
        opt.value = id;
        opt.textContent = id;
        deviceSelect.appendChild(opt);
      });
      if (ids.length) loadChartData(ids[0]);
    }

    async function loadChartData(deviceId) {
      const query = new AV.Query("CurrentData");
      query.equalTo("deviceId", deviceId);
      query.descending("timestamp");
      query.limit(500);
      const results = await query.find();
      const reversed = results.reverse();

      const labels = [];
      const data = [];

      reversed.forEach(entry => {
        const ts = new Date(new Date(entry.get("timestamp").iso).getTime() + 8 * 60 * 60 * 1000);
        labels.push(ts.toLocaleString("zh-CN"));
        const values = entry.get("currents").split("_").map(parseFloat);
        const avg = values.reduce((sum, v) => sum + v, 0) / values.length;
        data.push(avg);
      });

      if (myChart) myChart.destroy();
      myChart = new Chart(chartCtx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: "平均电流 (A)",
            data,
            borderColor: "#007bff",
            backgroundColor: "rgba(0, 123, 255, 0.2)",
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: {
              callbacks: {
                label: ctx => `电流: ${ctx.parsed.y.toFixed(2)} A`
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "时间 (北京时间)"
              }
            },
            y: {
              title: {
                display: true,
                text: "平均电流 (A)"
              }
            }
          }
        }
      });
    }

    deviceSelect.addEventListener("change", e => {
      loadChartData(e.target.value);
    });

    fetchDeviceIds();
  </script>
</body>
</html>