<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>电流监测图表</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    canvas {
      margin-top: 30px;
    }
    select {
      padding: 5px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>设备电流图表（CurrentData）</h2>

  <label for="deviceSelect">选择设备 ID：</label>
  <select id="deviceSelect"></select>

  <canvas id="currentChart" width="800" height="400"></canvas>

  <script>
    const appId = "bOJAr1GSAwLB55qdhahyz0tp-gzGzoHsz";
    const appKey = "gc9TLLQQwb6pYMFF8kpFJlLh";
    const baseUrl = "https://bojar1gs.lc-cn-n1-shared.com/1.1/classes/CurrentData";

    const headers = {
      "X-LC-Id": appId,
      "X-LC-Key": appKey,
      "Content-Type": "application/json"
    };

    const deviceSelect = document.getElementById("deviceSelect");
    const ctx = document.getElementById("currentChart").getContext("2d");

    let chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label: "电流 (A)",
          data: [],
          borderColor: "blue",
          fill: false,
          tension: 0.2
        }]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            type: "time",
            time: {
              tooltipFormat: "yyyy-MM-dd HH:mm:ss",
              displayFormats: {
                minute: "HH:mm",
                hour: "HH:mm"
              }
            },
            title: {
              display: true,
              text: "时间戳"
            }
          },
          y: {
            title: {
              display: true,
              text: "电流 (A)"
            }
          }
        }
      }
    });

    async function fetchDeviceIds() {
      const queryUrl = `${baseUrl}?limit=1000&keys=deviceId`;
      const res = await fetch(queryUrl, { headers });
      const json = await res.json();

      const ids = [...new Set(json.results.map(d => d.deviceId))];
      ids.forEach(id => {
        const option = document.createElement("option");
        option.value = id;
        option.textContent = id;
        deviceSelect.appendChild(option);
      });

      if (ids.length > 0) {
        loadChartData(ids[0]); // 默认加载第一个设备
      }
    }

    async function loadChartData(deviceId) {
      const url = `${baseUrl}?where=${encodeURIComponent(JSON.stringify({ deviceId }))}&limit=500&order=-timestamp`;
      const res = await fetch(url, { headers });
      const json = await res.json();

      const results = json.results.reverse(); // 时间升序

      const labels = [];
      const values = [];

      results.forEach(entry => {
        if (entry.timestamp && entry.currents) {
          const ts = new Date(entry.timestamp.iso);
          const averageCurrent = entry.currents
            .split("_")
            .map(Number)
            .reduce((a, b) => a + b, 0) / entry.currents.split("_").length;

          labels.push(ts);
          values.push(averageCurrent.toFixed(3));
        }
      });

      chart.data.labels = labels;
      chart.data.datasets[0].data = values;
      chart.update();
    }

    deviceSelect.addEventListener("change", () => {
      loadChartData(deviceSelect.value);
    });

    fetchDeviceIds();
  </script>
</body>
</html>