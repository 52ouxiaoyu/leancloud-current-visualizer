<!DOCTYPE html>
<html>
<head>
  <title>设备电流采样图</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- 日期适配器 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <style>
    .container {
      width: 90%;
      margin: 20px auto;
    }
    .controls {
      margin: 20px 0;
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .slider-container {
      margin: 20px 0;
      flex-grow: 1;
    }
    #timeRange {
      width: 100%;
    }
    .chart-container {
      height: 60vh;
      position: relative;
    }
    select {
      padding: 5px;
      font-size: 16px;
    }
    .version {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>电流采样图（每秒数据）</h2>
    <div class="controls">
      <div>
        <label for="deviceSelect">选择设备：</label>
        <select id="deviceSelect"></select>
      </div>
      <div>
        <label for="dateSelect">选择日期：</label>
        <input type="date" id="dateSelect">
      </div>
      <button id="refreshBtn">刷新数据</button>
    </div>
    <div class="chart-container">
      <canvas id="chart"></canvas>
    </div>
    <div class="slider-container">
      <input type="range" id="timeRange" min="0" max="100" value="100">
      <div id="rangeLabel">显示最近数据</div>
    </div>
    <div class="version" id="versionDisplay"></div>
  </div>

  <script>
    // 配置信息
    const appId = 'bOJAr1GSAwLB55qdhahyz0tp-gzGzoHsz';
    const appKey = 'gc9TLLQQwb6pYMFF8kpFJlLh';
    const className = 'CurrentData';
    const limit = 1000;
    let chart;
    let allData = [];

    // 添加版本号
    const version = 'v1.0.5';
    document.getElementById('versionDisplay').textContent = `版本号: ${version}`;

    // 获取所有设备ID（使用 LeanCloud cloudQuery API）
    async function fetchDevices() {
      const url = 'https://bOJAr1GSAwLB55qdhahyz0tp.api.lncldglobal.com/1.1/cloudQuery';
      const cql = 'select distinct deviceId from CurrentData';

      const res = await fetch(url, {
        method: 'POST',
        headers: {
          'X-LC-Id': appId,
          'X-LC-Key': appKey,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ cql })
      });

      if (!res.ok) {
        console.error('聚合查询失败:', res.status, res.statusText);
        return [];
      }

      const data = await res.json();
      if (!data.results) return [];

      const uniqueDevices = [...new Set(data.results.map(item => item.deviceId))];
      return uniqueDevices.filter(id => id);
    }


    // 更新设备选择下拉框
    async function updateDeviceSelect() {
      const devices = await fetchDevices();
      const select = document.getElementById('deviceSelect');
      select.innerHTML = devices.map(id => 
        `<option value="${id}"${id === '8C4F00B1B338' ? ' selected' : ''}>${id}</option>`
      ).join('');
    }

    async function fetchData() {
      const deviceId = document.getElementById('deviceSelect').value;
      const dateInput = document.getElementById('dateSelect').value;
      let url = `https://bojar1gs.lc-cn-n1-shared.com/1.1/classes/${className}?limit=${limit}&order=-timestamp`;
      
      const where = {};
      if (deviceId) {
        where.deviceId = deviceId;
      }
      if (dateInput) {
        const date = new Date(dateInput);
        const nextDay = new Date(date);
        nextDay.setDate(date.getDate() + 1);
        
        where.timestamp = {
          $gte: { __type: "Date", iso: date.toISOString() },
          $lt: { __type: "Date", iso: nextDay.toISOString() }
        };
      }
      
      if (Object.keys(where).length > 0) {
        url += `&where=${encodeURIComponent(JSON.stringify(where))}`;
      }

      const res = await fetch(url, {
        headers: {
          'X-LC-Id': appId,
          'X-LC-Key': appKey,
          'Content-Type': 'application/json'
        }
      });
      const data = await res.json();
      if (!data.results) {
        console.error('数据格式错误', data);
        return [];
      }

      // 处理每分钟的数据，拆分成每秒
      return data.results.flatMap(entry => {
        const currents = entry.currents.split('_').map(Number);
        const timestamp = new Date(entry.timestamp.iso);
        return currents.map((current, index) => ({
          time: new Date(timestamp.getTime() - (currents.length - 1 - index) * 1000),
          current: current
        }));
      }).sort((a, b) => a.time - b.time);
    }

    function updateChart(data) {
      const ctx = document.getElementById('chart').getContext('2d');
      
      if (chart) {
        chart.destroy();
      }

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: '电流 (mA)',
            data: data.map(d => ({
              x: d.time,
              y: d.current
            })),
            borderColor: 'rgb(75, 192, 192)',
            borderWidth: 1,
            pointRadius: 2,
            fill: false,
            tension: 0.1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: 'second',
                displayFormats: {
                  second: 'MM-dd HH:mm:ss',
                  minute: 'MM-dd HH:mm',
                  hour: 'MM-dd HH:mm'
                },
                tooltipFormat: 'yyyy-MM-dd HH:mm:ss'
              },
              title: {
                display: true,
                text: '时间'
              }
            },
            y: {
              title: {
                display: true,
                text: '电流 (mA)'
              },
              ticks: {
                callback: value => value.toFixed(2)
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: context => `电流: ${context.parsed.y.toFixed(2)} A`
              }
            }
          }
        }
      });
    }

    function updateTimeRange() {
      const slider = document.getElementById('timeRange');
      const label = document.getElementById('rangeLabel');
      const percentage = slider.value;
      
      const dataToShow = allData.slice(
        Math.floor(allData.length * (100 - percentage) / 100)
      );
      
      const timeRange = dataToShow.length > 0 
        ? `${dataToShow[0].time.toLocaleTimeString()} - ${dataToShow[dataToShow.length-1].time.toLocaleTimeString()}`
        : '无数据';
      
      label.textContent = `显示时间范围: ${timeRange} (${dataToShow.length} 条数据)`;
      updateChart(dataToShow);
    }

    async function refreshData() {
      allData = await fetchData();
      updateTimeRange();
    }

    function setDefaultDate() {
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      document.getElementById('dateSelect').value = dateStr;
    }

    async function initialize() {
      await updateDeviceSelect();
      setDefaultDate();
      document.getElementById('timeRange').addEventListener('input', updateTimeRange);
      document.getElementById('deviceSelect').addEventListener('change', refreshData);
      document.getElementById('dateSelect').addEventListener('change', refreshData);
      document.getElementById('refreshBtn').addEventListener('click', refreshData);
      await refreshData();

      // 每分钟自动刷新数据
      setInterval(refreshData, 60000);
    }

    initialize();
  </script>
</body>
</html>
